{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extracss %}
<link rel="stylesheet" href="{% static 'css/screening.css' %}">
<style>
    .card-header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 500;
    }

    .screening-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        margin-bottom: 2px;
        cursor: pointer;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .screening-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 500;
        color: #212529;
    }

    .screening-content {
        padding: 20px;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 4px 4px;
        margin-bottom: 10px;
    }

    .toggle-icon {
        font-size: 12px;
        color: #6c757d;
    }

    .btn-success {
        padding: 8px 20px;
        font-weight: 500;
    }

    /* Additional styles to match the image */
    .accordion {
        box-shadow: none;
    }

    .screening-header:hover {
        background-color: #e9ecef;
    }

    .screening-content {
        background-color: #fff;
    }
</style>
{% endblock extracss %}

{% block content %}
<div class='dashboard'>
    <div class='dashboard-app'>
        <div class='dashboard-content'>
            <div class='container'>
                <div class='card'>
                    <div class='card-header'>
                        <h1>FOLLOW UP</h1>
                    </div>
                    <div class='card-body'>
                        <form method="POST" action="" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <!-- Initial Screening Section -->
                            <div class="screening-section">
                                <div class="screening-header">
                                    <h3>Initial Screening</h3>
                                    <span class="toggle-icon">▼</span>
                                </div>
                                <div class="screening-content">
                                    <table>
                                        <tr>
                                            <td>{{ form.date_of_follow_up | as_crispy_field }}</td>
                                            <td>{{ form.psa | as_crispy_field }}</td>
                                            <td>{{ form.creatinine | as_crispy_field }}</td>
                                        </tr>
                                        <tr>
                                            <td>{{ form.wbc | as_crispy_field }}</td>
                                            <td>{{ form.rbc | as_crispy_field }}</td>
                                            <td>{{ form.hemoglobin | as_crispy_field }}</td>
                                        </tr>
                                        <tr>
                                            <td>{{ form.hematocrit | as_crispy_field }}</td>
                                            <td>{{ form.platelet | as_crispy_field }}</td>
                                            <td>{{ form.lactate_hydrogenase | as_crispy_field }}</td>
                                        </tr>
                                        <tr>
                                            <td>{{ form.alkaline_phosphatase | as_crispy_field }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- GAPSMA Section -->
                            <div class="screening-section">
                                <div class="screening-header">
                                    <h3>GAPSMA</h3>
                                    <span class="toggle-icon">▼</span>
                                </div>
                                <div class="screening-content">
                                    <table>
                                        <tr>
                                            <td>{{ form.gapsma_date | as_crispy_field }}</td>
                                        </tr>
                                        {% for organ in 'prostate,lymph_node,bone,brain,lung,liver'|split:',' %}
                                        <tr class="organ-row">
                                            <td>{{ form|getattr:'gapsma_'|add:organ|add:'_lesion_status'|as_crispy_field }}</td>
                                            <td>{{ form|getattr:'gapsma_'|add:organ|add:'_location'|as_crispy_field }}</td>
                                            <td>{{ form|getattr:'gapsma_'|add:organ|add:'_suv'|as_crispy_field }}</td>
                                            <td>{{ form|getattr:'gapsma_'|add:organ|add:'_size'|as_crispy_field }}</td>
                                        </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>

                            <!-- FDGPETCT Section -->
                            <div class="screening-section">
                                <div class="screening-header">
                                    <h3>FDGPETCT</h3>
                                    <span class="toggle-icon">▼</span>
                                </div>
                                <div class="screening-content">
                                    <table>
                                        <tr>
                                            <td>{{ form.fdgpetct_date | as_crispy_field }}</td>
                                        </tr>
                                        {% for organ in 'prostate,lymph_node,bone,brain,lung,liver'|split:',' %}
                                        <tr class="organ-row">
                                            <td>{{ form|getattr:'fdgpetct_'|add:organ|add:'_lesion_status'|as_crispy_field }}</td>
                                            <td>{{ form|getattr:'fdgpetct_'|add:organ|add:'_location'|as_crispy_field }}</td>
                                            <td>{{ form|getattr:'fdgpetct_'|add:organ|add:'_suv'|as_crispy_field }}</td>
                                            <td>{{ form|getattr:'fdgpetct_'|add:organ|add:'_size'|as_crispy_field }}</td>
                                        </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>

                            <!-- Assessment and Plan Section -->
                            <div class="screening-section">
                                <div class="screening-header">
                                    <h3>Assessment and Plan</h3>
                                    <span class="toggle-icon">▼</span>
                                </div>
                                <div class="screening-content">
                                    <table>
                                        <tr>
                                            <td>{{ form.assessment | as_crispy_field }}</td>
                                        </tr>
                                        <tr>
                                            <td>{{ form.plan | as_crispy_field }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleSection(sectionId) {
        const content = document.getElementById(sectionId);
        const header = content.previousElementSibling;
        const icon = header.querySelector('.toggle-icon');
        
        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
            icon.textContent = '▼';
        } else {
            content.style.display = 'none';
            icon.textContent = '▶';
        }
    }

    function toggleLesionFields(organType, scanType) {
        const status = document.getElementById(`id_${scanType}_${organType}_lesion_status`).value;
        const fields = ['location', 'suv', 'size'];
        
        fields.forEach(field => {
            const element = document.getElementById(`id_${scanType}_${organType}_${field}`);
            const parentDiv = element.closest('div');
            if (status === 'Absent') {
                element.value = '';
                element.disabled = true;
                parentDiv.style.opacity = '0.5';
            } else {
                element.disabled = false;
                parentDiv.style.opacity = '1';
            }
        });
    }

    // Add event listeners for all lesion status fields
    const organs = ['prostate', 'lymph_node', 'bone', 'brain', 'lung', 'liver'];
    const scanTypes = ['gapsma', 'fdgpetct'];

    organs.forEach(organ => {
        scanTypes.forEach(scanType => {
            const statusField = document.getElementById(`id_${scanType}_${organ}_lesion_status`);
            if (statusField) {
                statusField.addEventListener('change', () => toggleLesionFields(organ, scanType));
                // Initialize fields on page load
                toggleLesionFields(organ, scanType);
            }
        });
    });
</script>

{% endblock content %}

{% block extrajs %}
<script src="{% static 'js/screening.js' %}"></script>
{% endblock extrajs %}
